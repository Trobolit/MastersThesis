\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, amssymb, amsfonts}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{cancel}
\usepackage[margin=3cm]{geometry}
%\usepackage{enumitem} % Allow tight lists
\usepackage{gensymb} % for degree symbol
\usepackage{tikzscale}

%\title{Robust control system development for VTOL-to-fixed wing flight %transition with the EcoSoar UAV}
%\author{Robert Hedman}
%\date{April 2019}


\begin{document}

\begin{titlepage}
    \begin{center}
        %\vspace*{1cm}
 
        \huge
        \textbf{Robust control system development for VTOL-to-fixed wing flight transition with the EcoSoar UAV}
 
        \vspace{0.5cm}
        \LARGE
        A thesis in Automatic Control
 
        \vspace{1.5cm}
 
        \textbf{Robert Hedman\\}
        \today
        \vspace{0.6cm}

        \includegraphics[width=0.9\textwidth]{coverphoto.jpeg}
 
        \vfill
 
        A thesis presented for the degree of\\
        Masters of Science / Civil Engineer
 
        \vspace{0.6cm}
 
        \Large
        Department of Computer Science, Electrical and Space Engineering\\
        Luleå University of Technology\\
        \textit{Supervisors:} K. \textsc{Atta}, K. \textsc{Kochersberger}\\
        \textit{Examinator:} G. \textsc{Nikolakopoulos}
 
    \end{center}
\end{titlepage}

\abstract
A non linear quaternion based attitude controller of type P2 controller, together with a sensitivity normalizing function for the control surfaces has been simulated and implemented on a flying fixed wing with non vectored engines.
In simulations the controller worked well in all flight modes, hovering, transition and flying, and also rejected a simple wind disturbance in all modes.
The first implementation on hardware did not work due to programming errors causing crashed with unrepairable damages.
The second aircraft was built out of a piece of ply wood to further simplify the testing.
A non-existing airfoil, flat plate, has no effects due to camber and is so easier to both simulate and tune.
The controller worked well/acceptable/bad/terrible in reality, maybe because of?


\newpage
\section*{\textit{Acknowledgements}}

Thank teachers that helped, Mr. K, Avory, Wife, etc.

[Lets see if they require rent before adding below]\\
I also want to extend a very warm thank you to Montford Special Needs College in Malawi for allowing me to stay there together with my wife during this thesis.
The staff also provided all the support needed to become integrated with the local culture and helping out with practical issues such as getting a car, finding the hospital and providing a safe circle of friends.

\newpage

\tableofcontents

\newpage
\input{listvars}
\newpage

\section{Background}
\input{background}

\section{Problem Forumulation}
\input{problemformulation}

\section{Theory}
To develop this controller some basic concepts are required.
\subsection{State Space}
Many systems can be written as a set of differential equation.

Physical systems may sometimes be mathematically modeled by state space representation, given that it can be written on the same form as equation \ref{eq:generalstatespace} below.
\begin{equation}
    \dot{\bar{x}} = f(\bar{x}) + g(\bar{u},\bar{x})
    \label{eq:generalstatespace}
\end{equation}
The states, $\bar{x}$ are related by a set of first order differential equations and some input.

Systems can have one input and one state/output, called Single Input Single Output (SISO), or have either multiple input or outputs or both; Multiple Input Multiple Output (MIMO) systems.
A system with several states, i.e. $\bar{x}$ being a vector, and several inputs, i.e. $\bar{u}$ being a vector is thus represented by a set of functions $\bar{f}$ and $\bar{g}$.

From basic fundamental physical laws, e.g. newtons laws, a set of differential equation for many physical systems can be derived.
Once the state space equations are known simulating the system is only a matter of choosing a differential equation solver.
Simulink has built in solver for these equations over time making it easy to simulate the system once the equations are known.

\subsection{State estimation/observers}
A full state vector may not always be exactly measurable so estimating it is of importance.
The Pixhawk PX4 firmware already includes an extended Kalman filter for estimating the position and attitude from an angular rate sensor, accelerometer, barometer and magnetometer.
For this project the built in Kalman filter will be used to estimate the state with which the control system will act upon.

\subsection{Reference Frames}
When working with rigid bodies in 3d space a reference system is needed.
In most of airplane dynamics for small scale aircraft the standard is a cartesian coordinate system with the x-axis aligned with North, y-axis aligned with East and the z-axis pointing down.
The body frame is similar, x-axis pointing forwards, y-axis along right wing and z-axis through the belly of the aircraft, i.e. down when flying normally.
This correspond to the well used Roll-Pitch-Yaw system.\cite{nelson}

\subsection{Quaternions}
Euler angles are intuitive but suffer from singularities.
Since normal aircraft normally do not spend time pointing straight up these singularities do not matter too much, but a VTOL capable tail-sitter will, so using quaternions is beneficial.

A quaternion, $\bold{q}$ is a four dimensional hyper complex number.\cite{P2}
\begin{equation}
 \mathbf{q} = q_0 + q_1 \mathbf{i} + q_2 \mathbf{j} + q_3 \mathbf{k}
\end{equation}
where $i^2 = j^2 = k^2 = ijk = -1$.\cite{Sola2016}
The imaginary part can be referenced to as the vector part and $q_0$ the scalar part.
The conjugate of a quaternion is defined as
\begin{equation}
     \mathbf{q^*} = q_0 - q_1 \mathbf{i} - q_2 \mathbf{j} - q_3 \mathbf{k}
\end{equation}
The quaternion can also be represented as a vector:
\begin{equation}
     \bold{q} = \left[
     \begin{matrix}
     q_0 &q_1 &q_2 &q_3
     \end{matrix}\right]
\end{equation}
The norm of a quaternion is defined by
\begin{equation}
    ||\mathbf{q}|| = \sqrt{\mathbf{q} \otimes \mathbf{q}^*} = \sqrt{q_0^2 + q_1^2 + q_2^2 + q_3^2}
\end{equation}
If the norm of a quaternion is equal to $1$ it is a unit quaternion.
Unit quaternions are very computationally efficient at describing rotations in 3D.
They also do not suffer from any singularities like the common Roll-Pitch-Yaw / Euler angles system.
Unit quaternions can always be written as
\begin{equation}
    \mathbf{q} = \left[\begin{matrix} cos \theta &\\ \mathbf{u} sin \theta\end{matrix}\right]
\end{equation}
where $\mathbf{u}$ is the vector $\left[\begin{matrix} q_1 & q_2 & q_3 \end{matrix}\right]$
describing the axis of which to rotate around and $\theta$ is proportional to the amount of rotation about that axis.
Multiplying unit quaternions yield a unit quaternion describing the joint rotation of the two initial quaternions.
The conjugate of a quaternion gives the opposite rotation direction around the same vector.
This can correspond to going from a world frame to body frame, or vice versa.
Multiplying a reference quaternion describing a set orientation for an object in 3D with the conjugate of its actual quaternion therefore gives the error in orientation, attitude.

A more in depth description of quaternions and their mathematics please see \cite{Sola2016}.

%\subsection{Equations of Motion, in body frame}


\subsection {Basic aerodynamics}
\input{basicaero}

\section{Mathematical Model of EcoSoar}
To develop a control system first a simulator needs to be developed, and so the aircraft has to be mathematically modeled.
To not make the simulator too time consuming to develop nor to complex a few assumptions will be made:
\input{assumptions}

%\input{coordsys}

\input{aerodynamics}

\subsubsection{Forces and moments due to accelerated body reference frame}
\input{accrefframe}


\subsubsection{elevons}
\input{elevons}

\subsection{Winglets, forces and moments due to sideslip}
\input{sideslip}

\subsection{Propeller Thrust}
\input{thrust}

\subsection{Restoring moment due to roll rate}
\input{restmomroll}

\subsection{Restoring moment due to yaw rate}
\input{restmomyaw}

\subsection{Rolling moment due to yaw rate}
\input{rollmomyaw}

\subsection{Restoring moment due to pitch rate}
\input{restmompitch}


\input{actuatordyn}


\input{fulleqs}


\section{EcoSoar replacement}
Due to logistical issues in Malawi the full dual engine Eco-Soar could not be built.
As a proof of concept a flying board was built to see if the controller would be feasible to implement on an EcoSoar in the future.
\subsection{Parameter adjustments}
Since a flying board has no camber all effects due to camber has been removed in the simulator.
Also all physical measurements are replaced with those of the flying board.
All other critical physical phenomena has been accounted for.
The flying board has similar winglets.
It has a similar c.g. vs center of pressure, two control surfaces partially covered by the propeller wakes and electronics in the middle to separate the two wings slightly. 
Measurements are roughly similar, the flying board is slightly longer and has a much shorter wingspan, but the physics should be comparable.


\subsection{Building}
A piece of plywood was bought at the local market area.
Engine mounts were 3D-printed.
Elevon areas were cut out of the board and poster board was cut to fit in the slots as elevons.
Winglets were cut out in poster board to roughly same size as on the eco soar, and hot glued onto the top of the board to provide the physics of sideslip stability.
A 5.5Ah 3S-LiPo was zip tied to the board in the very front.
Two Electronic Speed controllers of type KDEXF-UAS35 were hoy glued on the sides of the battery in the very front as well.
The ESCs were selected specifically to have a very fast response and lots of power to spare as to not become a limiting factor.
The engines are the same as on the EcoSoar: 1300KV 420W three phase brushless motors.
Two small 2kg/cm servos were mounted close to the elevons as actuators, linked with musical wire.
A telemetry module and receiver were mounted far away from other electronics to minimize interference.
The Pixhawk was glued behind the battery as close to the center of gravity as reasonable.
Gluing provides a sturdier mount to the board for more accurate reading than using double sided tape.
Due to the many crashes of the EPO wing which resulted in broken propellers two carbon rods were mounted perpendicular to the board, one in front on each side.
When the board lands the propellers will not hit the ground as easily.
The rods are held in place by tight fitting rubber bands on each side of the board so to provide some dampening effect should the landing be very hard.

\begin{figure}
    \center
    \includegraphics[width=0.9\textwidth]{FlyingBoard.jpg}
    \caption{A picture of the flying board, made out of plywood. The propellers are just placeholders for the photo.}
\end{figure}

\subsection{Parameter estimation/declarations}
Wing areas can all be measured. Inertias have been estimated in a CAD program.


\section{\textbf{Robust controller development and Implementation}}

The controller implemented is based on a non-linear Proportional squared ($P^2$) controller by Emil Fresk\cite{P2}.
The controller was first implemented on a simulator of the EcoSoar made in Simulink.
A few other controllers were first attempted, among them a Feedback Linearization controller.

\subsection{Feedback Linearization}
Didn't work.
\subsubsection{Mimo: Lie derivatives and brackets}
\subsubsection{Decoupling matrix}
\subsection{L1 parameter compensation/estimation}
Maybe still needed?


\subsection{Simulink}
The full non linear state space equations derived above in section \ref{sec:fulleqs} were put in a matlab function block surrounded by state integrators to generate the full state.
Parameters were either measured or estimated to complete the numerical simulator.
Controllers could then be tested and evaluated quickly.
A instant render of the simulation was also added through Simulinks VR support blocks.

\subsection{Pixhawk firmware}
Mathworks has support for the embedded coder to directly upload apps into the PX4 NuttX Real Time OS that can run on the Pixhawk 1.
The firmware has to be flashed to PX4 on the Pixhawk, files modified on the SD card and a wide range of supporting softwares must be installed on the host computer.
Mathworks has great documentation on the subject.\cite{MathworksPX4}

\subsection{Initial testing on Bixler}
The evaluate the firmware/simulink controller deployment into a Pixhawk a Bixler was used.
The Pixhawk was put into the Bixler to replace the receiver inside, necessary hardware added and then a simple FlyByWire controller was implemented and uploaded into the Pixhawk from Simulink.
Results were very good, the Bixler flew as expected and no issues with the software on-board.
\subsection{P2-controller - Flying foam wing}
The Pixhawk was then removed and placed on a small flying fixed wing with dual rotors, E-flite X-VERT VTOL BNF Basic EFL1850, to test a simple version of the full controller.
The P2 controller \cite{P2} was implemented along with separate tuning for the three axis.
The implemented controller can thus be thought of as a set of three P-D controllers, one for each axis.
The E-flite would hover well, but no logs could initially be produced due to a bug in the embedded coder in Simulink.

The brushless motors built into the E-flite are only designed for a 2 cell LiPo battery, but due to the added weight of the Pixhawk and ESCs their thrust was not sufficient.
By doubling the voltage to a 4 cell Battery it would hover nicely.
After a few crashes new propellers had to be 3D printed to replace those included which broke.
The added load from the 3D printed propellers not being as efficient made the motors burn up.
The motors from the EcoSoar were added since they are much more heavy duty.
3D printed adapters were made to allow attaching the new motors to the E-flite.


\subsection{Torque translator}
The E-flite has propeller wakes that cover the entire elevon.
The EcoSoar does not.
Therefor it is of interest to normalize the actuation signals given the current state so that they produce the requested torque from the P2 controller in any given state.
By assuming that the airflow inside the wake and outside the wake do not affect each other and that the dynamic pressure is the dominating effect a simple function can be found that takes the current rotational speeds of the propellers, the current velocity of the aircraft and requested torque around $x$ and $y$ axis and gives the deflection angle of the control surfaces.

We assume that damping due to rotational speeds do not exist, winglets have no $z$-offset, and no net pitch moment is created by the lift from the wings.
The equations for torque around each axis then become:
\begin{equation}
\begin{split}
    \tau_x =& y_f ( F_L + F_{L_T} - F_{R_T} -F_R) \\
    \tau_y =& x_f ( F_{L_T} + F_L + F_{R_T} + F_R) \\
    \tau_z =& y_T ( T_L - T_R)
\end{split}
\end{equation}
which indicates that the elevons force per deflection is proportional to the airflow speed over them squared.
The P2 controller outputs desired angular acceleration, $\dot{\omega_i}$, not torque.
Necessary torque, $\tau_i$, for axis $i$ is given by
\begin{equation}
    \tau_i = \dot{\omega_i} I_i
\end{equation}
Solving for differential thrust is possible.
Taking the inertia around each axis into account the necessary deflection for each elevon, $u_{\delta_i}$ can be solved for given the current state:
\begin{equation}
\begin{split}
    u_{\delta_L} =& \frac{-0.5 \tau_y}{k_1 sgn(v_x) v^2 + k_2 \omega_L^2} - \frac{0.5 \tau_x}{k_3 sgn(v_x) v^2 + k_4\omega_L^2} \\
    u_{\delta_R} =& \frac{-0.5 \tau_y}{k_1 sgn(v_x) v^2 + k_2 \omega_R^2} + \frac{0.5 \tau_x}{k_3 sgn(vx) v^2 + k_4 \omega_R^2} 
\end{split}
\end{equation}
where $k_{[1-4]}$ are numerical constants given by aircraft parameters.


\section{Results}
\subsection{Performance in Simulations}
Since all parameters are well known/set in the simulator and assumptions are the same for the simulator and controller the system works very well in simulation.

\subsection{Performance of the EcoSoar in reality}

\section{Conclusion}

\begin{thebibliography}{9}
\bibitem{latexcompanion} 
Michel Goossens, Frank Mittelbach, and Alexander Samarin. 
\textit{The \LaTeX\ Companion}. 
Addison-Wesley, Reading, Massachusetts, 1993.

\bibitem{einstein} 
Albert Einstein. 
\textit{Zur Elektrodynamik bewegter K{\"o}rper}. (German) 
[\textit{On the electrodynamics of moving bodies}]. 
Annalen der Physik, 322(10):891–921, 1905.

\bibitem{nelson}
Robert C Nelson
\textit{Flight Stability and Automatic Control}
[\textit{Second Edition}]
ISBN: 0-07-066110-3

\bibitem{P2}
Emil Fresk and George Nikolakopoulos
\textit{Full Quaternion Based Attitude Control for a Quadrotor}
2013 European Control Conference (ECC)
July 17-19, 2013, Zürich, Switzerland.
978-3-033-03962-9/©2013 EUCA

\bibitem{aoa180}
Robert E. Sheldahl, Paul C. Klimes
\textit{Aerodynamic CHaracteristics of Seven Symmetrical Airfoil Sections Through 180-Degree Angle of Attack for Use in Aerodynamic Analysis of Vertical Axis Wind Turbines}
Sandia National Laboratories - energy report
SAND80-2114 Unlimited Release UC-60

\bibitem{aoa180-2}
Roberto Naldi, Lorenzo Marconi
\textit{Optimal transition maneuvers for a class of V/STOL aircraft}

Center for Research on Complex Automated Systems (CASY) Giuseppe Evangelisti, DEIS - Department of Electronic, Computer Science and Systems, University of Bologna, Viale
Risorgimento 2, 40136 Bologna, Italy
0005-1098 
2011 Elsevier Ltd.
doi:10.1016/j.automatica.2011.01.027

\bibitem{Sola2016}
Joan Sol\`{a}
\textit{Quaternion kinematics for the error-state KF}
February 2, 2016

\bibitem{aerodynamics}
John Anderson
\textit{Fundamentals of Aerodynamics}
Sixth Edition
McGraw-Hill Education
ISBN 978-1-259-12991-9

\bibitem{pixhawkthesis}
Ryan G. Beall
June 2017
\textit{ENGINEERING OF FAST AND ROBUST ADAPTIVE
CONTROL FOR FIXED-WING UNMANNED AIRCRAFT}
NAVAL POSTGRADUATE SCHOOL MONTEREY, CALIFORNIA

\bibitem{MathworksPX4}
https://se.mathworks.com/hardware-support/px4-autopilots.html


\end{thebibliography}


\end{document}\grid



 Sort above into (Abstract), Introduction/Background, Modelling, Controller, Results, Conclusion, and any other titles that might be suitable.